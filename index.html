<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Nixie Radio</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:100" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="main.css">
</head>

<body>

    <div id="sidebaropener" class="sidebar" onclick="openSidebar()"><i class="fa-solid fa-gear"></i></div>

    <div id="sidebar" class="sidebar">
        <label for="loopColor" style="font-size: 14px; font-family: monospace; color: white;">Loop Color</label>
        <input type="checkbox" name="loopColor" id="loopColor" onclick="loopColor()" style="font-size: 14px; font-family: monospace;" />
        <br><br>
        <input type="color" id="selcolor" value="#ffe548" oninput="changeColor(this.value)">

        <a href="https://github.com/ryddle/nixie-radio" id="github" target="_blank" style="float: right;margin-top: -25px;">
            <div style="height: 32px;width: 32px;background: black;border-radius: 50%;">
                <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" data-view-component="true" style="fill: white;">
                    <path
                        d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z">
                    </path>
                </svg>
            </div>
        </a>
    </div>


    <div class="clock">
        <div class="trapezoid_left"></div>
        <div class="trapezoid_right"></div>
        <div class="trapezoid"></div>
        <section class="hours">
            <div class="tens">
                <p>0</p>
                <p>1</p>
                <p>2</p>
                <p>3</p>
                <p>4</p>
                <p>5</p>
                <p>6</p>
                <p>7</p>
                <p>8</p>
                <p>9</p>
                <div class="bottom"></div>
            </div>
            <div class="ones">
                <p>0</p>
                <p>1</p>
                <p>2</p>
                <p>3</p>
                <p>4</p>
                <p>5</p>
                <p>6</p>
                <p>7</p>
                <p>8</p>
                <p>9</p>
                <div class="bottom" style="left: 143px;"></div>
            </div>
        </section>
        <p class="separator">:</p>
        <div class="bottom" style="left: 225px; width: 30px; top: 132px;"></div>
        <section class="mins">
            <div class="tens">
                <p>0</p>
                <p>1</p>
                <p>2</p>
                <p>3</p>
                <p>4</p>
                <p>5</p>
                <p>6</p>
                <p>7</p>
                <p>8</p>
                <p>9</p>
                <div class="bottom" style="left: 274px;"></div>
            </div>
            <div class="ones">
                <p>0</p>
                <p>1</p>
                <p>2</p>
                <p>3</p>
                <p>4</p>
                <p>5</p>
                <p>6</p>
                <p>7</p>
                <p>8</p>
                <p>9</p>
                <div class="bottom" style="left: 355px;"></div>
            </div>
        </section>
        <p class="separator">:</p>
        <div class="bottom" style="left: 437px;width: 30px;top: 132px;"></div>
        <section class="secs">
            <div class="tens">
                <p>0</p>
                <p>1</p>
                <p>2</p>
                <p>3</p>
                <p>4</p>
                <p>5</p>
                <p>6</p>
                <p>7</p>
                <p>8</p>
                <p>9</p>
                <div class="bottom" style="left: 486px;"></div>
            </div>
            <div class="ones">
                <p>0</p>
                <p>1</p>
                <p>2</p>
                <p>3</p>
                <p>4</p>
                <p>5</p>
                <p>6</p>
                <p>7</p>
                <p>8</p>
                <p>9</p>
                <div class="bottom" style="left: 567px;"></div>
            </div>
        </section>
        <div class="clockbase"></div>
        <button id="timeMode" class="control-btn control-btn-style active" style="left: 43px; visibility: hidden;" state="0"><i
                class="fa-solid fa-clock-rotate-left fa-flip-horizontal"></i></button><!-- <i class="fa-regular fa-clock"></i>  <i class="fa-solid fa-clock-rotate-left fa-flip-horizontal"></i>  <i class="fa-solid fa-clock-rotate-left"></i>  -->
        <div id="control-buttons" class="control-buttons">
            <button id="prev" class="control-btn-style"><i class="fa-solid fa-backward-step"></i></button>
            <button id="play" class="control-btn-style"><i class="fa-solid fa-pause"></i></button>
            <button id="next" class="control-btn-style"><i class="fa-solid fa-forward-step"></i></button>
        </div>
        <button id="openMusic" class="control-btn control-btn-style"><i class="fa-solid fa-eject"></i></button>

        <div id="speaker" style="position: absolute;
        left: 40px;
        top: 200px;
        width: 300px;
        height: 300px;
        border-radius: 50px;
        background-color: #1d1100;
        box-shadow: 1px 6px 10px 2px #0e0800;">
            <div id="speaker_grill" style="position: absolute;
            left: 20px;
            top: 20px;
            width: 260px;
            height: 260px;
            border-radius: 30px;
            background-color: #988f81;
            background: radial-gradient(circle at center, #000 50%, transparent 22%), #554024;
            background-size: 10px 10px;"></div>
        </div>

        <div id="gauge" style="
        position: absolute;
        left: 390px;
        top: 250px;
        width: 280px;
        height: 220px;
        border-radius: 50%;
        background-color: #1d1100;
        box-shadow: 1px 6px 10px 2px #0e0800;
        ">
            <div id="gauge_elm" style="
            position: absolute;
            left: 10px;
            top: 10px;
            width: 260px;
            height: 200px;
            border-radius: 50%;
            background-color: #af9c7e;
            box-shadow: 1px 6px 10px 2px #0e0800;
            ">
                <canvas width="260" height="240" id="canvas" style="
                    position: absolute;
                    left: 0px;
                    top: -48px;
                "></canvas>
                <span style="position: absolute;left: 107px;top: 106px;font-family: serif;font-size: 8px;color: black; user-select: none;">ryddle .co 1940</span>
            </div>
        </div>

        <div id="gauge_glass" style="
        position: absolute;
        left: 400px;
        top: 260px;
        width: 250px;
        height: 190px;
        border-radius: 50%;
        z-index: 10;
        background: linear-gradient(45deg, rgba(224, 217, 146, 0.5186449579831933) 0%, rgba(224, 217, 146, 0) 35%, rgba(224, 217, 214, 0.4) 55%, rgba(224, 217, 146, 0.4430147058823529) 70%, rgba(224, 217, 146, 0) 100%);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(0.5px);
        -webkit-backdrop-filter: blur(0.5px);
        border: 6px solid rgb(255 255 255 / 10%);
        filter: sepia(60%);
        "></div>

        <div id="slider" style="display: none;
        position: absolute;
        left: 40px;
        top: 545px;
        width: 630px;
        height: 30px;
        border-radius: 50px;
        background-color: #1d1100;
        box-shadow: inset 1px 6px 10px 2px #0e0800;">
            <div id="sliderbar" style="    position: absolute;
            left: 5px;
            top: 13px;
            width: 274px;
            height: 4px;
            border-radius: 5px;
            /* background-color: rgb(var(--red), var(--green), var(--blue), 0.5); */
            /*
            background: radial-gradient(circle, var(--ligth-color) 50%, transparent 22%) 0% 0% / 1px 1px, rgb(85, 64, 36);
            background-size: 6px;
            */
            
            background: radial-gradient(circle, var(--ligth-color) 50%, transparent 150%) 0% 0% / 1px 1px, rgb(85, 64, 36);
            background-size: 14px;
           
            box-shadow: 0px 0px 15px 1px var(--ligth-color);"></div>

            <div id="sliderknob" style="
            position: absolute;
            left: 0px;
            top: -5px;
            width: 20px;
            height: 40px;
            ">
                <div id="sliderknob_top" style="
                position: absolute;
                left: 1px;
                top: -4px;
                width: 18px;
                height: 11px;
                background-color: rgb(84 52 25);
                transform: perspective(35px) rotateX(115deg);
                "></div>

                <div id="sliderknob_left" style="
                position: absolute;
                left: 0px;
                top: 0px;
                width: 2px;
                height: 39px;
                background-color: rgb(66 37 12);
                transform: skewY(54deg);
                "></div>

                <div id="sliderknob_right" style="
                position: absolute;
                left: 18px;
                top: 0px;
                width: 2px;
                height: 39px;
                background-color: rgb(84 52 25);
                transform: skewY(144deg);
                "></div>

                <div id="sliderknob_front" style="
                position: absolute;
                left: 2px;
                top: 3px;
                width: 16px;
                height: 37px;
                background-color: var(--wood-dark);
                "></div>

                <div id="sliderknob_scratch" style="
                position: absolute;
                left: 8px;
                top: 6px;
                width: 4px;
                height: 30px;
                background-color: var(--ligth-color);
                box-shadow: inset -1px -1px 2px 0px rgb(65 52 38);
                "></div>
            </div>
        </div>
    </div>

    <div id="sidebaropener2" onclick="openPlaylist()">
        <i class="fa-regular fa-rectangle-list"></i>
    </div>

    <div id="playlistsidebar" class="playlistsidebar">
    </div>

    <input type="file" id="file" accept="audio/**" style="display: none;" multiple>
    <audio id="audio" crossorigin="anonymous" preload="auto" buffered></audio>

    <script src="js/gauge.min.js"></script>
    <script src="nixie.js"></script>
</body>

</html>
<script>
    function m3uToJson(m3u) {
        var lines = m3u.split('\n');
        var json = [];
        var track = {};

        for (var i = 0; i < lines.length; i++) {
            if (lines[i].startsWith("#EXTM3U")) continue;
            if (lines[i].startsWith('#EXTINF:')) {
                let name = "";
                let info = lines[i].substring(8);
                info = info.split(',');
                if (info.length > 1) {
                    name = info[1];
                } else {
                    name = info[0];
                }
                track = {
                    "name": name,
                    "streaming_url": lines[i + 1],
                    "type": "audio/mpeg"
                };
                if (Object.keys(track).length > 0) {
                    json.push(track);
                }
            } else {
                if (i > 0 && (lines[i - 1] == "#EXTM3U" || lines[i - 1].startsWith('#EXTINF:') || lines[i].length == 0)) continue;
                track = {
                    "name": lines[i],
                    "streaming_url": lines[i],
                    "type": "audio/mpeg"
                };
                if (Object.keys(track).length > 0) {
                    json.push(track);
                }
            }
        }

        /* if (Object.keys(track).length > 0) {
            json.push(track);
        } */

        return json;
    }


    function openSidebar() {
        document.getElementById("sidebaropener").classList.remove("fadeIn");
        document.getElementById("sidebaropener").classList.add("fadeOut");

        document.getElementById("sidebar").classList.remove("fadeOut");
        document.getElementById("sidebar").classList.add("fadeIn");
    }

    function closeSidebar() {
        document.getElementById("sidebaropener").classList.remove("fadeOut");
        document.getElementById("sidebaropener").classList.add("fadeIn");

        document.getElementById("sidebar").classList.remove("fadeIn");
        document.getElementById("sidebar").classList.add("fadeOut");
    }

    function openPlaylist() {
        document.getElementById("sidebaropener2").classList.remove("fadeIn");
        document.getElementById("sidebaropener2").classList.add("fadeOut");

        document.getElementById("playlistsidebar").classList.remove("fadeOut");
        document.getElementById("playlistsidebar").classList.add("fadeIn");
    }

    function closePlaylist() {
        document.getElementById("sidebaropener2").classList.remove("fadeOut");
        document.getElementById("sidebaropener2").classList.add("fadeIn");

        document.getElementById("playlistsidebar").classList.remove("fadeIn");
        document.getElementById("playlistsidebar").classList.add("fadeOut");
    }

    document.addEventListener("click", function (event) {
        if (!event.target.closest("#sidebaropener") && !event.target.closest("#sidebar")) {
            closeSidebar();
        }

        if (!event.target.closest("#sidebaropener2") && !event.target.closest("#playlistsidebar")) {
            closePlaylist();
        }
    });


    ////////////////////////////////////////////////////////////////////////////////////
    var sources = [];
    var tracks = [];
    var currentTrack = 0;
    var baseTimer = null;
    function nextTrack() {
        if(isSliding) {
            return;
        }
        currentTrack = (currentTrack + 1) % tracks.length;

        var ol = document.getElementById("playlist");
        for (var i = 0; i < ol.children.length; i++) {
            ol.children[i].style.backgroundColor = "transparent";
            ol.children[i].style.color = "var(--ligth-color)";
            ol.children[i].children[0].style.color = "var(--ligth-color)";
        }

        var li = ol.children[currentTrack];
        li.style.backgroundColor = "var(--ligth-color)";
        li.style.color = "rgb(var(--accessible-color), var(--accessible-color), var(--accessible-color))";
        li.children[0].style.color = "rgb(var(--accessible-color), var(--accessible-color), var(--accessible-color))";

        document.getElementById("sliderknob").style.left = "0px";
        /* document.getElementById("sliderbar").style.background = "linear-gradient(90deg, rgb(var(--red) var(--green) var(--blue)) 0%, rgb(0 0 0) 0%)"; */
        document.getElementById("sliderbar").style.width = "0px";

        document.getElementById("audio").src = tracks[currentTrack];
        document.getElementById("audio").load();

        togglePlay();
    }

    function prevTrack() {
        currentTrack = (currentTrack - 1 + tracks.length) % tracks.length;

        var ol = document.getElementById("playlist");
        for (var i = 0; i < ol.children.length; i++) {
            ol.children[i].style.backgroundColor = "transparent";
            ol.children[i].style.color = "var(--ligth-color)";
            ol.children[i].children[0].style.color = "var(--ligth-color)";
        }

        var li = ol.children[currentTrack];
        li.style.backgroundColor = "var(--ligth-color)";
        li.style.color = "rgb(var(--accessible-color), var(--accessible-color), var(--accessible-color))";
        li.children[0].style.color = "rgb(var(--accessible-color), var(--accessible-color), var(--accessible-color))";

        document.getElementById("sliderknob").style.left = "0px";
        /* document.getElementById("sliderbar").style.background = "linear-gradient(90deg, rgb(var(--red) var(--green) var(--blue)) 0%, rgb(0 0 0) 0%)"; */
        document.getElementById("sliderbar").style.width = "0px";

        document.getElementById("audio").src = tracks[currentTrack];
        document.getElementById("audio").load();

        togglePlay();
    }

    function togglePlay() {
        if (document.getElementById("audio").paused) {
            document.getElementById("audio").play();
            document.getElementById("play").innerHTML = "<i class='fa-solid fa-pause'></i>";

            setDigits(hours, (currentTrack < 10) ? "0" + (currentTrack + 1) : (currentTrack + 1) + "");
        } else {
            document.getElementById("audio").pause();
            document.getElementById("play").innerHTML = "<i class='fa-solid fa-play'></i>";
        }
    }

    const secondsToHHMMSSObj = function (sec_num) {
        var hours = Math.floor(sec_num / 3600);
        var minutes = Math.floor((sec_num - (hours * 3600)) / 60) % 60;
        var seconds = Math.round(sec_num - (hours * 3600) - (minutes * 60)) % 60;
        var h = "00", m = "00", s = "00";
        if (hours < 10) { h = "0" + hours; } else { h = hours + ""; }
        if (minutes < 10) { m = "0" + minutes; } else { m = minutes + ""; }
        if (seconds < 10) { s = "0" + seconds; } else { s = seconds + ""; }
        return { h: h, m: m, s: s };
    }

    function updateDisplay() {
        if (timeMode == 0) {
            tick();
        } else {
            updatePlayTime();
        }
    }

    function updatePlayTime() {
        var currentTime = document.getElementById("audio").currentTime;
        var duration = document.getElementById("audio").duration;
        var time = (timeMode == 1) ? currentTime : duration - currentTime;
        var parsedTime = secondsToHHMMSSObj(time);

        setDigits(hours, (currentTrack < 10) ? "0" + (currentTrack + 1) : (currentTrack + 1) + "");
        setDigits(mins, parsedTime.m);
        setDigits(secs, parsedTime.s);
    }

    var timeMode = 0;
    function toggleTimeMode() {
        var btn = document.getElementById("timeMode");
        if (btn.getAttribute("state") == 0) {
            btn.setAttribute("state", 1);
            btn.innerHTML = "<i class='fa-solid fa-clock-rotate-left'></i>";
        } else if (btn.getAttribute("state") == 1) {
            btn.setAttribute("state", 2);
            btn.innerHTML = "<i class='fa-regular fa-clock'></i>";
        } else {
            btn.setAttribute("state", 0);
            btn.innerHTML = "<i class='fa-solid fa-clock-rotate-left fa-flip-horizontal'></i>";
        }
        timeMode = btn.getAttribute("state");
        updateDisplay();
    }

    function createPlaylist(files) {
        var ol = document.createElement("ol");
        ol.id = "playlist";
        ol.className = "playlist";
        for (var i = 0; i < files.length; i++) {
            var li = document.createElement("li");
            li.className = "track";
            var a = document.createElement("a");
            a.href = "#";
            a.className = "tracklink";
            a.index = i;
            a.addEventListener("click", function () {
                currentTrack = this.index;

                for (var i = 0; i < ol.children.length; i++) {
                    ol.children[i].style.backgroundColor = "transparent";
                    ol.children[i].style.color = "var(--ligth-color)";
                    ol.children[i].children[0].style.color = "var(--ligth-color)";
                }

                this.parentElement.style.backgroundColor = "var(--ligth-color)";
                this.parentElement.style.color = "rgb(var(--accessible-color), var(--accessible-color), var(--accessible-color))";
                this.style.color = "rgb(var(--accessible-color), var(--accessible-color), var(--accessible-color))";
                document.getElementById("audio").src = tracks[currentTrack];
                document.getElementById("audio").load();
                togglePlay();
            });
            a.innerHTML = files[i].name;

            if (i == 0) {
                li.style.backgroundColor = "var(--ligth-color)";
                li.style.color = "rgb(var(--accessible-color), var(--accessible-color), var(--accessible-color))";
                a.style.color = "rgb(var(--accessible-color), var(--accessible-color), var(--accessible-color))";
            }

            li.appendChild(a);
            ol.appendChild(li);
        }

        document.getElementById("playlistsidebar").appendChild(ol);
    }


    function getAudioEnergy() {
        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
        var analyser = audioContext.createAnalyser();
        var source = audioContext.createMediaElementSource(document.getElementById("audio"));
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        var bufferLength = analyser.frequencyBinCount;
        var dataArray = new Uint8Array(bufferLength);
        var average = 0;
        return function () {
            analyser.getByteFrequencyData(dataArray);
            for (var i = 0; i < bufferLength; i++) {
                average += dataArray[i];
            }
            average = average / bufferLength;
            return average;
        };
    }

    document.getElementById("timeMode").addEventListener("click", toggleTimeMode);

    document.getElementById("next").addEventListener("click", nextTrack);
    document.getElementById("prev").addEventListener("click", prevTrack);
    document.getElementById("play").addEventListener("click", togglePlay);

    document.getElementById("audio").addEventListener("ended", nextTrack);
    var audiotimer = 0;
    document.getElementById("audio").addEventListener('play', async () => {
        var getEnergy = getAudioEnergy();

        audiotimer = setInterval(function () {
            gauge.set(getEnergy());
        }, 20);
    });

    document.getElementById("audio").addEventListener('timeupdate', function () {
        let nl = map(this.currentTime, 0, this.duration, 0, 610);
        document.getElementById("sliderknob").style.left = nl + "px";
        let npercent = map(this.currentTime, 0, this.duration, 0, 100);
        /* document.getElementById("sliderbar").style.background = "linear-gradient(90deg, rgb(var(--red) var(--green) var(--blue)) " + npercent + "%, rgb(0 0 0) " + npercent + "%)"; */
        document.getElementById("sliderbar").style.width = nl + "px";
    });



    document.getElementById("openMusic").addEventListener("click", function () {
        if (this.classList.contains("active")) {
            document.getElementById("audio").pause();
            document.getElementById("audio").currentTime = 0;
            this.classList.remove("active");
            this.innerHTML = "<i class='fa-solid fa-eject'></i>";

            document.getElementById("control-buttons").querySelectorAll("button").forEach(function (button) {
                button.classList.remove("active");
            });
            document.getElementById("control-buttons").style.display = "none";
            document.getElementById("timeMode").style.visibility = "hidden";

            tracks = [];
            sources = [];
            currentTrack = 0;

            timeMode = 0;

            document.getElementById("playlistsidebar").innerHTML = "";

            document.getElementById("audio").src = "";
            document.getElementById("file").value = null;

            document.getElementById("slider").style.display = "none";

        } else {
            document.getElementById("file").click();
        }
    });

    async function readFileAsText(file) {
        let result = await new Promise((resolve) => {
            let fileReader = new FileReader();
            fileReader.onload = (e) => resolve(fileReader.result);
            fileReader.readAsText(file);
        });
        return result;
    }

    document.getElementById("file").addEventListener("input", async function () {
        if (this.files && this.files[0]) {
            document.getElementById("openMusic").innerHTML = "<i class='fa-solid fa-power-off'></i>";
            document.getElementById("openMusic").classList.add("active");

            for (let i = 0; i < this.files.length; i++) {
                let file = this.files[i];
                if (file.type == "audio/x-mpegurl") {
                    let m3u = await readFileAsText(file);
                    var playlist = m3uToJson(m3u);
                    for (let j = 0; j < playlist.length; j++) {
                        let blob = await fetch(playlist[j].streaming_url).then(res => res.blob());
                        tracks.push(URL.createObjectURL(blob));
                        sources.push({ src: URL.createObjectURL(blob), name: playlist[j].name, type: playlist[j].type });
                        //tracks.push(playlist[j].streaming_url);
                        //sources.push({ src: playlist[j].streaming_url, name: playlist[j].name, type: playlist[j].type });
                    }
                } else {
                    tracks.push(URL.createObjectURL(file));
                    sources.push({ src: URL.createObjectURL(file), name: file.name, type: file.type }); // or audio/mp3, or audio/ogg
                }
            }

            document.getElementById("audio").src = tracks[currentTrack];
            document.getElementById("audio").load();

            timeMode = 1;

            document.getElementById("timeMode").setAttribute("state", 1);

            togglePlay();

            createPlaylist(sources);

            document.getElementById("control-buttons").querySelectorAll("button").forEach(function (button) {
                button.classList.add("active");
            });
            document.getElementById("control-buttons").style.display = "block";
            document.getElementById("timeMode").style.visibility = "visible";

            document.getElementById("slider").style.display = "block";
        } else {
            document.getElementById("control-buttons").querySelectorAll("button").forEach(function (button) {
                button.classList.remove("active");
            });
            document.getElementById("control-buttons").style.display = "none";
            document.getElementById("slider").style.display = "none";
        }
    });

    document.getElementById("slider").addEventListener("mouseup", function (event) {
        if (isSliding) {
            return;
        }
        let x = event.offsetX;//event.clientX - this.offsetLeft;
        let nl = Math.max(0, Math.min(610, x));
        document.getElementById("sliderknob").style.left = nl + "px";
        let npercent = map(nl, 0, 610, 0, 100);
        /* document.getElementById("sliderbar").style.background = "linear-gradient(90deg, rgb(var(--red) var(--green) var(--blue)) " + npercent + "%, rgb(0 0 0) " + npercent + "%)"; */
        document.getElementById("sliderbar").style.width = nl + "px";
        let time = map(x, 0, this.offsetWidth, 0, document.getElementById("audio").duration);
        document.getElementById("audio").currentTime = time;
    });

    var left_offset = 0;
    var isSliding = false;
    document.getElementById("sliderknob").addEventListener("mousedown", function (event) {
        left_offset = event.clientX - this.offsetLeft;
        isSliding = true;
    });

    document.addEventListener("mousemove", function (event) {
        if (event.buttons == 1 && isSliding) {
            let x = event.clientX - left_offset;
            let nl = Math.max(0, Math.min(610, x));
            document.getElementById("sliderknob").style.left = nl + "px";
            let npercent = map(nl, 0, 610, 0, 100);
            /* document.getElementById("sliderbar").style.background = "linear-gradient(90deg, rgb(var(--red) var(--green) var(--blue)) " + npercent + "%, rgb(0 0 0) " + npercent + "%)"; */
            document.getElementById("sliderbar").style.width = nl + "px";
            let time = map(x, 0, 610, 0, document.getElementById("audio").duration-2);
            document.getElementById("audio").currentTime = time;
        }
    });

    document.addEventListener("mouseup", function (event) {
        isSliding = false;
    });

    baseTimer = setInterval(updateDisplay, 1000);

    /////////////////////////////////////////////////////////////////
    var opts = {
        angle: 0.18,
        /*angle: -0.25,*/
        lineWidth: 0.02,
        radiusScale: 0.6,
        pointer: {
            length: 0.6,
            strokeWidth: 0.02,
            color: '#000000'
        },
        staticLabels: {
            font: "10px sans-serif",
            labels: [0, 20, 40, 60, 80, 100, 120, 140],
            fractionDigits: 0
        },
        renderTicks: {
            divisions: 10,
            divWidth: 1.1,
            divLength: 1.7,
            divColor: '#333333',
            subDivisions: 6,
            subLength: 1.5,
            subWidth: 0.6,
            subColor: '#666666'
        },
        background: "#c2c1a6",
        staticZones: [
            { strokeStyle: "#000000", min: 0, max: 90 },
            { strokeStyle: "#d5996a", min: 90, max: 120 },
            { strokeStyle: "#d56363", min: 120, max: 140 }
        ],
        limitMax: false,
        limitMin: false,
        highDpiSupport: true
    };
    var target = document.getElementById('canvas'); // your canvas element
    var gauge = new Gauge(target).setOptions(opts); // create sexy gauge!
    gauge.maxValue = 140; // set max gauge value
    gauge.setMinValue(0);  // set min value
    gauge.set(0); // set actual value

</script>